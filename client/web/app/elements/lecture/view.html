<link rel="stylesheet" href="../../../bower_components/bootstrap/dist/css/bootstrap.min.css">

<dom-module id="lecture-view">
    <style>
        .tempSecondsPicker{
            padding: 10px;
        }
        .show{

        }
        .row{
            @apply(--layout-horizontal);
            @apply(--layout-center);
            width: 100%;
        }
        @media screen and (max-width: 1280px) {
            .row{
                @apply(--layout-vertical);
                @apply(--layout-center);
                width: 100%;
            }
        }
        .show-video{
            text-align: center;
        }
        .slider{
            padding: 20px;
            width: 100%;
        }
    </style>

    <template>
        <lectures-service id="lectures" on-response="lecturesResponse" last-response="{{lecture}}"></lectures-service>
        <div class="row">
            <div class="col-md-6 col-sm-12 show show-video">
                <google-youtube
                        id="googleYouTube"
                        video-id="{{lecture.videoUrl}}"
                        rel="0"
                        start="0"
                        autoplay="0"
                        on-currenttime-changed="playerChanged"
                        width="100%"
                        height="{{videoHeight}}px"
                        style="margin: auto auto;"
                >
                </google-youtube>
            </div>
            <div class="col-md-6 col-sm-12 show show-slide">
                <canvas id="the-canvas" style="border:1px  solid black"></canvas>
            </div>
        </div>
        <div class="row">
            <div class="slider">
                <time-grider mappings="{{lecture.mapping}}" on-choose-slide="clickedSlide"></time-grider>
            </div>
        </div>

        <div class="row text-center" style="display:block;">
            <paper-button on-tap="delete" class="success danger" raised>Usu≈Ñ</paper-button></a>
            <a href$="/lecture/{{lecture.id}}/edit"><paper-button raised>Edytuj</paper-button></a>
        </div>

    </template>

    <script>
        Polymer({
            is: "lecture-view",
            properties: {
                videoHeight:{
                    type: Number,
                    value: 200
                },
                lectureId: {
                    type: String,
                    notify: true,
                    reflectToAttribute: true,
                    observer: "lectureChanged"
                },
                currentSlide: {
                    type: Number,
                    value: -1,
                    observer: "renderPdf"
                }
            },
            setCurrentSlide: function(slide) {
                this.set('currentSlide', slide);
            },
            clickedSlide: function(e){
                console.log("youtubeslider-choose time&slide");
                console.log("to time: ", e.detail.time);

                this.async(function(){this.$.googleYouTube.seekTo(e.detail.time)}, 10);
                this.setCurrentSlide(e.detail.slide);
            },
            playerChanged: function(time){
                console.log("playerChanged");
                console.log(time);
                if (time.detail.value == 0) {
                    return;
                }
                var slideId = this.findCurrentImage(time);
                this.setCurrentSlide(slideId);
            },
            findCurrentImage: function(time){
                var secToSlides = this.lecture.mapping;
                var id = 0;
                for(var i = 0; i< secToSlides.length; i++){
                    if(i>0 && secToSlides[i].time > time.detail.value){
                        id = secToSlides[i-1].slide;
                        console.log(secToSlides[i-1].time, time);
                        break;
                    }
                }
                console.log("id: ", id);
                return id;
            },
            lecturesResponse: function(e){
                console.log("oneslide response", e)
            },
            lectureChanged: function(){
                console.log("video ID: ", this.lectureId)
                //TODO
                this.$.lectures.get(this.lectureId);
            },
            ready: function(){
                if(window.innerWidth > 1279) this.videoHeight = 480;
                else if(window.innerWidth > 799) this.videoHeight = 300;

                var googleYouTube  = this.$.googleYouTube;
                page.exit('/lecture/:id', function(ctx, next) {
                    googleYouTube.pause();
                    next();
                });

                this.setCurrentSlide(0);
            },

            renderPdf: function() {
                var pageId = this.currentSlide + 1;
                console.log("render pdf with page", pageId)
                //
                // If absolute URL from the remote server is provided, configure the CORS
                // header on that server.
                //
                var url = 'src/spring/pres.pdf';

                //
                // Disable workers to avoid yet another cross-origin issue (workers need
                // the URL of the script to be loaded, and dynamically loading a cross-origin
                // script does not work).
                //
                // PDFJS.disableWorker = true;

                //
                // The workerSrc property shall be specified.
                //
                PDFJS.workerSrc = '../../../bower_components/pdfjs-dist/build/pdf.worker.js';

                var desiredHeight = this.videoHeight;
                //
                // Asynchronous download PDF
                //
                PDFJS.getDocument(url).then(function getPdf(pdf) {
                    //
                    // Fetch the first page
                    //
                    pdf.getPage(pageId).then(function getPage(page) {
                      var origViewport = page.getViewport(1);
                      var scale = desiredHeight / origViewport.height;
                      var viewport = page.getViewport(scale);

                      //
                      // Prepare canvas using PDF page dimensions
                      //
                      var canvas = document.getElementById('the-canvas');
                      var context = canvas.getContext('2d');
                      canvas.height = viewport.height;
                      canvas.width = viewport.width;

                      //
                      // Render PDF page into canvas context
                      //
                      var renderContext = {
                        canvasContext: context,
                        viewport: viewport
                      };
                      page.render(renderContext);
                    });
                });
            },
            delete: function(){
                this.$.lectures.delete(this.lectureId);
                page('/movie-search');
            }
        });
    </script>

</dom-module>
