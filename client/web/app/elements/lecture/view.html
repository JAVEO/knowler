<dom-module id="lecture-view">
    <style>
        .slider{
            padding: 20px;
            width: 100%;
        }
        .row{
            @apply(--layout-horizontal);
            @apply(--layout-center);
            width: 100%;
        }
        @media screen and (max-width: 1280px) {
            .row{
                @apply(--layout-vertical);
                @apply(--layout-center);
                width: 100%;
            }
        }
        .text-blue {
            color: var(--paper-blue-800);
        }
        .text-grey {
            color: var(--paper-grey-700);
        }
        .title {
            font-size: 2em;
        }
        .description {
            font-size: 1.2em;
            margin-top: 5px;
        }
        .views-count {
            font-size: 1.25em;
        }
        .author-image {
            width: 25px;
            height: 25px;
        }
        .card-presentation {
            padding: 0px;
            background: black;
        }
        paper-card.rate {
            @apply(--layout-horizontal);
        }
        .card-img {
            padding: 20px;
        }
        .rate-content {
            @apply(--layout-flex);
            float: left;
            cursor: pointer;
        }
        .rate-header {
            @apply(--paper-font-headline);
        }
        .rate-name {
            color: var(--paper-grey-600);
            margin: 10px 0;
        }
        paper-icon-button.rate-icon {
            --iron-icon-fill-color: white;
            --iron-icon-stroke-color: var(--paper-grey-600);
        }
    </style>

    <template>
        <firebase-document
            id="firebase"
            location="{{backendDocument}}"
            data="{{lecture}}"></firebase-document>
        <firebase-collection
            id="firebaseCollection"
            location="[[config.urls.backend]]"
            order-by-child="author/id"
            equal-to="{{lecture.author.id}}"
            limit-to-first="5"
            data="{{lectures}}"></firebase-collection>

        <iron-signals on-iron-signal-auth="_authStateChange"></iron-signals>
        <iron-meta id="meta"></iron-meta>


        <div id="view-container" class="layout vertical">
            <paper-material elevation="1" class="card-default card-presentation flex">
               <presentation-player id="presentationPlayer" lecture="{{lecture}}"></presentation-player>
            </paper-material>

            <paper-material elevation="1" class="card-default flex">
                <div class="layout horizontal end">
                    <p class="flex title text-blue mb-0">{{lecture.title}}</p>
                    <p class="views-count text-blue mb-0">{{lecture.viewCount}} views</p>
                </div>
                <div class="layout horizontal end">
                    <div class="flex text-grey">
                        <img class="img-rounded author-image" src="{{authorImageUrl}}">
                        {{lecture.author.name}}
                    </div>
                    <div class="text-grey">
                        <p class="mb-0">Published on {{_formatDate(lecture.createdDate)}}</p>
                    </div>
                </div>
                <p class="description">{{lecture.description}}</p>

                <div class="text-right">
                    <social-share lecture-id="{{lectureId}}" text="{{lecture.title}}"></social-share>
                </div>

                <div class="text-center">
                    <paper-button hidden$="{{!isOwner}}" on-tap="delete" class="danger" raised>Delete</paper-button></a>
                    <a hidden$="{{!isOwner}}" href$="/lecture/{{lectureId}}/edit"><paper-button raised>Edit</paper-button></a>
                </div>
            </paper-material>
        </div>

        <div class="layout horizontal wrap"> 
            <div class="k-col-md-6 k-col-sm-12">
                <paper-material elevation="1" class="card-default">
                    <disqus-comments id="knowlerComments" shortname="[[config.disqus.shortname]]" identifier="{{lectureId}}" https="[[config.disqus.https]]" title="{{lecture.title}}" url="[[config.urls.frontend]]/{{lectureId}}"></disqus-comments>
               </paper-material>
            </div>
            <div class="k-col-md-6 k-col-sm-12">
                <paper-material elevation="1" class="card-default">
                    <h4>Recommended</h4>
                    <template is="dom-repeat" items="{{lectures}}">
                        <paper-card class="rate" on-tap="viewDetails">
                            <div class="rate-content">
                                <p>
                                    <img src="https://i.ytimg.com/vi/{{item.videoId}}/mqdefault.jpg" align="left" class="card-img">
                                    <div class="card-content">
                                        <div class="rate-header">{{item.title}}</div>
                                        <div class="rate-name">{{item.author.name}}</div>
                                        <div>{{item.viewCount}} views</div>
                                    </div>
                                </p>
                            </div>
                        </paper-card>
                    </template>

                </paper-material>
            </div>
        </div>
    </template>

    <script>
        Polymer({
            is: "lecture-view",
            properties: {
                config: Object,
                currentSlide: {
                    type: Number,
                },
                lecture: {
                    type: Object,
                    observer: "lectureChanged"
                },
                lectureId: {
                    type: String,
                    notify: true,
                    reflectToAttribute: true,
                    observer: "lectureIdChanged"
                },
                isOwner: {
                    type: Boolean,
                    value: false
                },
                backendDocument: String,
                authorImageUrl: {
                    type: String
                }
            },
            lectureIdChanged: function(lectureId) {
                if (StringUtils.isEmpty(lectureId)) {
                    return;
                }
                this.set('backendDocument', Config.urls.backend + '/' + lectureId);
                this.$.knowlerComments.reset();

                var viewCountRef = new Firebase(this.backendDocument + '/viewCount');
                viewCountRef.transaction(function(viewCount) {
                  return viewCount + 1;
                });
            },
            ready: function(){
                var self = this;
                this.set('config', Config);

                page.exit('/lecture/:id', function(ctx, next) {
                    self.$.presentationPlayer.pause();
                    next();
                });
            },
            _formatDate: function(timestamp) {
                if (timestamp === undefined) {
                    return "unknown";
                }
                return DateUtils.timestampToHumanDate(timestamp);
            },
            delete: function() {
                this.$.firebaseCollection.removeByKey(this.lectureId);
                page('/lecture-search/#taehc[]');
            },
            _setIsOwner: function(user, lecture) {
                if (user === undefined || lecture === undefined) {
                    this.set('isOwner', false);
                    return;
                }
                var isOwner = user.getEmail() === lecture.author.email;
                this.set('isOwner', isOwner);
            },
            _authStateChange: function(e, data) {
                this._setIsOwner(data.user, this.lecture);
            },
            lectureChanged: function(lecture) {
                var self = this;

                function loadAuthorImage() {
                    var url = "https://www.googleapis.com/plus/v1/people/" + lecture.author.id + "?fields=image&key=" + Config.google.developerKey;
                    var defaultImage = "../../images/default-avatar.png";
                    self.set('authorImageUrl', defaultImage);

                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function(response) {
                        if (xhr.status == 404) {
                            self.set('authorImageUrl', defaultImage);
                            return;
                        }
                        if (xhr.readyState == XMLHttpRequest.DONE) {
                            self.set('authorImageUrl', JSON.parse(xhr.responseText).image.url);
                        }
                    };
                    xhr.open("GET", url, true);
                    xhr.send();
                }


                loadAuthorImage();
                this._setIsOwner(this.$.meta.byKey('user'), lecture);
            },
            viewDetails: function(e) {
                window.scrollTo(0, 0);
                page('/lecture/' + e.model.item.__firebaseKey__);
            }
        });
    </script>

</dom-module>
