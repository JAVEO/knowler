<dom-module id="lecture-view">
    <style>
        .slider{
            padding: 20px;
            width: 100%;
        }
        .row{
            @apply(--layout-horizontal);
            @apply(--layout-center);
            width: 100%;
        }
        @media screen and (max-width: 1280px) {
            .row{
                @apply(--layout-vertical);
                @apply(--layout-center);
                width: 100%;
            }
        }
        h2 {
            color: var(--paper-blue-600);
        }
    </style>

    <template>
        <h2>{{lecture.title}}</h2>
        <lectures-service id="lectures" last-response="{{lecture}}" on-response="lecturesResponse"></lectures-service>
        <fullscreen-api id="fsapi"></fullscreen-api>

        <div id="presentationContent" class="row">
            <div class="col-md-6 col-sm-12">
                <google-youtube
                        id="googleYouTube"
                        video-id="{{lecture.videoId}}"
                        rel="0"
                        start="0"
                        autoplay="0"
                        on-currenttime-changed="playerChanged"
                        on-google-youtube-ready="_youtubeReady"
                        on-google-youtube-state-change="_youtubeStateChanged"
                        width="100%"
                        height="{{videoHeight}}px"
                        style="margin: auto;">
                </google-youtube>
            </div>
            <div class="col-md-6 col-sm-12">
                <pdf-viewer id="pdfViewer" file-id="{{lecture.fileId}}" current-slide="{{currentSlide}}" slide-height="{{videoHeight}}"></pdf-viewer>
            </div>
        </div>
        <div class="row">
            <div class="slider">
                <time-grider id="timeGrider" duration="{{duration}}" mappings="{{lecture.mappings}}" on-choose-slide="clickedSlide"></time-grider>
            </div>
        </div>

        <div class="row text-center" style="display:block;">
            <paper-button hidden$="{{hiddenEditButton}}" on-tap="delete" class="danger" raised>Delete</paper-button></a>
            <a hidden$="{{hiddenEditButton}}" href$="/lecture/{{lectureId}}/edit"><paper-button raised>Edit</paper-button></a>
            <paper-button on-tap="goFullscreen" raised>
                <iron-icon icon="icons:fullscreen"></iron-icon>
            </paper-button></a>
        </div>

        <social-share url="http://knowler.com" text="{{lecture.title}}"></social-share>

        <div class="row text-right" style="display:block;">
            <iron-icon icon="icons:visibility"></iron-icon>
            {{statistics.viewCount}}
            <iron-icon icon="icons:thumb-up"></iron-icon>
            {{statistics.likeCount}}
            <iron-icon icon="icons:thumb-down"></iron-icon>
            {{statistics.dislikeCount}}
        </div>

        <disqus-comments id="knowlerComments" shortname="knowler" identifier="{{lectureId}}" https="true"></disqus-comments>
    </template>

    <script>
        Polymer({
            is: "lecture-view",
            properties: {
                videoHeight: {
                    type: Number,
                },
                currentSlide: {
                    type: Number,
                },
                duration:{
                    type: Number
                },
                lectureId: {
                    type: String,
                    notify: true,
                    reflectToAttribute: true,
                    observer: "lectureChanged"
                },
                loggedUser: {
                    type: String
                },
                hiddenEditButton: {
                    type: Boolean,
                    value: true
                },
                fsapi: {
                    type: Object
                },
                statistics: {
                    type: Object
                }
            },
            setCurrentSlide: function(slide) {
                this.set('currentSlide', slide);
            },
            clickedSlide: function(e){
                e.detail = e.detail.element;
                console.log("To time: ", e.detail.time);

                this.async(function(){this.$.googleYouTube.seekTo(e.detail.time);}, 10);
                this.setCurrentSlide(e.detail.slide);
            },
            playerChanged: function(time){
                console.log("playerChanged");

                if (time.detail.value === 0) {
                    return;
                }
                var slideId = this.findCurrentImage(time);
                this.setCurrentSlide(slideId);
                this.$.timeGrider.markAsSelected(slideId);
            },
            _youtubeReady: function(e) {
                this.set('duration', GoogleYouTubeUtils.getVideoDuration(e));
            },
            _youtubeStateChanged: function(e) {
                var newDuration = GoogleYouTubeUtils.getVideoDuration(e);
                if (newDuration !== 0 && this.duration !== newDuration) {
                    this.set('duration', newDuration);
                }
            },
            findCurrentImage: function(time){
                var secToSlides = this.lecture.mappings;
                var id = 0;
                for(var i = 0; i< secToSlides.length; i++){
                    if(i>0 && secToSlides[i].time > time.detail.value){
                        id = secToSlides[i-1].slide;
                        console.log(secToSlides[i-1].time, time);
                        break;
                    }
                }
                console.log("id: ", id);
                return id;
            },
            goFullscreen: function () {
                this.fsapi.toggleFullscreen();
            },
            lectureChanged: function(newId, oldId) {
                if (StringUtils.isEmpty(this.lectureId)) {
                    return;
                }
                this.$.lectures.get(this.lectureId);
                this.$.knowlerComments.reset();
            },
            ready: function(){
                var fsapi = this.$.fsapi;
                fsapi.target = this.$.presentationContent;
                this.fsapi = fsapi;

                this.videoHeight = GoogleYouTubeUtils.determinePreferredHeight();

                var googleYouTube  = this.$.googleYouTube;
                page.exit('/lecture/:id', function(ctx, next) {
                    googleYouTube.pause();
                    next();
                });
            },
            delete: function(){
                this.$.lectures.delete(this.lectureId);
                page('/lecture-search');
            },
            setLoggedUser: function(user) {
                this.set('loggedUser', user);
            },
            lecturesResponse: function() {
                var last = this.$.lectures.lastResponse;
                var hidden = !(this.loggedUser !== undefined && this.loggedUser === last.author);
                this.set('hiddenEditButton', hidden);
                var self = this;

                gapi.client.load('youtube', 'v3', function() {
                    console.log("Youtube API loaded");
                    gapi.client.youtube.videos.list({
                        'part': 'snippet,contentDetails,statistics',
                        'key': GoogleConfig.developerKey,
                        'id': last.videoId
                    }).then(function(response){
                        console.log("Youtube API response:", response);
                        var stats = response.result.items[0].statistics;
                        self.set('statistics' , stats);
                    });
                });
            }
        });
    </script>

</dom-module>
