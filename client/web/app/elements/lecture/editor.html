<dom-module id="lecture-editor">
    <style>
        .slider{
            padding: 20px;
            width: 100%;
        }
        .tool-bar {
            @apply(--layout-horizontal);
            @apply(--layout-justified);
        }
        .green {
            color: var(--paper-green-300);
        }
        .mt-50 {
            margin-top: 50px;
        }
        h2 {
            color: var(--paper-blue-600);
        }
        paper-input, paper-dropdown-menu {
            width: 100%;
        }
    </style>
    <template>

        <paper-material elevation="1" class="card-default">
            <h2>{{lecture.title}}</h2>
            <div class="row">
                <div class="col-sm-6">
                    <paper-input value="{{lecture.title}}" label="Title"></paper-input>
                </div>
                <div class="col-sm-6">
                    <paper-input value="{{lecture.description}}" label="Description"></paper-input>
                </div>
                <div class="col-sm-6">
                    <paper-dropdown-menu horizontal-align="left" label="Category">
                        <paper-menu class="dropdown-content" selected="{{lecture.category}}" on-iron-select="_categorySelected">
                            <template is="dom-repeat" items="[[config.categories]]">
                                <paper-item data-value="{{item}}" class="capitalize">{{item}}</paper-item>
                            </template>
                        </paper-menu>
                    </paper-dropdown-menu>
                </div>
            </div>
            <div class="row layout horizontal">

                <div class="col-md-6 col-sm-12">
                    <youtube-search-select video-id="{{lecture.videoId}}"></youtube-search-select>
                    <google-youtube
                            id="presentation"
                            autoplay="1"
                            video-id="{{lecture.videoId}}"
                            height="{{videoHeight}}px"
                            width="100%"
                            rel="0"
                            start="0"
                            autoplay="0"
                            on-google-youtube-ready="_youtubeReady"
                            on-google-youtube-state-change="_youtubeStateChanged"
                            style="margin: auto;">
                    </google-youtube>
                </div>
                <div class="col-md-6 col-sm-12">
                    <google-picker id="googlePicker" file-id="{{lecture.fileId}}"></google-picker>
                    <pdf-viewer id="pdfViewer" file-id="{{lecture.fileId}}"
                                current-slide="{{currentSlide}}"
                                slide-height="{{videoHeight}}"
                                on-pdf-changed="pdfChanged"></pdf-viewer>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12 slider">
                    <time-grider id="timeGrider" selected="{{currentSlide}}" editable="true" duration="{{duration}}" mappings="{{lecture.mappings}}" on-choose-slide="_updateSelectedSection"></time-grider>
                </div>
                <div class="col-sm-12">
                    <slide-list id="slideList"></slide-list>
                </div>
            </div>

            <div class="tool-bar">
                <form on-submit="_timeFromChanged">
                    <paper-input id="fromInput" class="flex-none" label="Start time" value="{{timeFrom}}">
                        <paper-icon-button id="fromButton" on-tap="_timeFromChanged" class="self-end green" suffix icon="check"></paper-icon-button>
                    </paper-input>
                </form>
                <form on-submit="_timeToChanged">
                    <paper-input id="toInput" class="flex-none" label="End time" value="{{timeTo}}">
                        <paper-icon-button id="toButton" on-tap="_timeToChanged" class="self-end green" suffix icon="check"></paper-icon-button>
                    </paper-input>
                </form>
                <div class="self-end">
                    <paper-button class="flex-none" toggles raised on-tap="delete"><iron-icon icon="delete"></iron-icon> Delete</paper-button>
                </div>
            </div>

            <div class="text-center mt-50" style="display:block;">
                <paper-button on-tap="save" class="success" raised>Save</paper-button>
            </div>

        </paper-material>

        <firebase-collection id="firebaseCollection"
                             location="[[config.urls.backend]]"></firebase-collection>
        <firebase-document id="firebase"></firebase-document>
        <iron-meta id="meta"></iron-meta>
    </template>
    <script>
        Polymer({
            is: 'lecture-editor',
            properties: {
                config: Object,
                videoHeight: {
                    type: Number
                },
                selectedIndex: Number,
                timeFrom: Number,
                timeTo: Number,
                lectureId: {
                    type: String,
                    notify: true,
                    observer: 'lectureIdChanged'
                },
                lecture: {
                    type: Object,
                    notify: true
                },
                duration: {
                    type: Number
                },
                currentSlide: {
                    type: Number
                },
                pagesCount: {
                    type: Number
                }
            },
            observers: [
                'generateNewMappings(lecture.videoId, duration, pagesCount)'
            ],
            lectureIdChanged: function() {
                if (this.lectureId === undefined) {
                    this.lecture = this.createLecture();
                    return;
                } else {
                    this.$.firebase.set('location', Config.urls.backend + '/' + this.lectureId);
                    var data = this.$.firebase.data;
                    this.lecture = data;
                }
            },
            createLecture: function() {
                return {
                         fileId: undefined,
                         videoId: undefined,
                         category: undefined,
                         title: undefined,
                         description: undefined,
                         mappings: []
                     };
            },
            _categorySelected: function(e, data) {
                this.set('lecture.category', data.item.dataValue);
            },
            pdfChanged: function(e) {
                this.$.slideList.set('pdf', e.detail.value);
                this.set('pagesCount', e.detail.value.numPages);
            },
            _updateSelectedSection: function(e) {
                var self = this;

                function getNextTime(index) {
                    if (index < self.lecture.mappings.length - 1) {
                        return self.lecture.mappings[index + 1].time;
                    }
                    return self.duration;
                }

                this.selectedIndex = e.detail.index;

                console.log("Updating form");
                this.timeFrom = this.lecture.mappings[this.selectedIndex].time.toHHMMSS();
                this.timeTo = getNextTime(this.selectedIndex).toHHMMSS();

                var isFirst = this.selectedIndex === 0;
                this.$.fromButton.disabled = isFirst;
                this.$.fromInput.disabled = isFirst;

                var isLast = this.selectedIndex === this.lecture.mappings.length - 1;
                this.$.toButton.disabled = isLast;
                this.$.toInput.disabled = isLast;

                console.log("Updating video and presentation view");
                var selectedMapping = this.lecture.mappings[this.selectedIndex];
                this.async(function() {
                    this.$.presentation.seekTo(selectedMapping.time);
                }, 10);
                this.setCurrentSlide(selectedMapping.slide);
            },
            setCurrentSlide: function(slide) {
                this.set("currentSlide", slide);
            },
            _youtubeReady: function(e) {
                this.set('duration', GoogleYouTubeUtils.getVideoDuration(e));
            },
            _youtubeStateChanged: function(e) {
                var newDuration = GoogleYouTubeUtils.getVideoDuration(e);
                if (newDuration !== 0 && this.duration !== newDuration) {
                    this.set('duration', newDuration);
                }
            },
            generateNewMappings: function(videoUrl, duration, pagesCount) {
                if (duration === 0) {
                    console.log("Mappings will not be generated, duration: " + duration + " is not valid");
                    return;
                }

                if (ArrayUtils.isNotEmpty(this.lecture.mappings)) {
                    return;
                }
                console.log("Generating default mappings");
                var mappings = [];
                var singleDur = this.duration / pagesCount;
                for (var i = 0; i < pagesCount; i++) {
                    mappings.push({
                        time: Math.round(singleDur * i),
                        slide: i
                    });
                }
                this.set('lecture.mappings', mappings);
            },
            ready: function() {
                this.set('config', Config);
                this.lecture = this.createLecture();

                this.videoHeight = GoogleYouTubeUtils.determinePreferredHeight();
                var self = this;
                page.exit('/lecture/:id/edit', function(ctx, next) {
                    self.$.presentation.pause();
                    next();
                });
            },
            save: function() {
                if (this.lectureId === undefined) {
                    var user = this.$.meta.byKey('user');
                    this.set('lecture.author', {
                                id: user.getId(),
                                email: user.getEmail(),
                                name: user.getName()
                             });

                    var response = this.$.firebaseCollection.add(this.lecture);
                    page('/lecture/' + response.key());
                } else {
                    this.$.firebase.set('data.title', this.lecture.title);
                    this.$.firebase.set('data.description', this.lecture.description);
                    this.$.firebase.set('data.fileId', this.lecture.fileId);
                    this.$.firebase.set('data.videoId', this.lecture.videoId);
                    this.$.firebase.set('data.mappings', this.lecture.mappings);
                    this.$.firebase.set('data.category', this.lecture.category);
                    page('/lecture/' + this.lectureId);
                }
                this.lecture = this.createLecture();
            },
            delete: function() {
                this.lecture.mappings.splice(this.selectedIndex, 1);
                this.$.timeGrider.mappingChanged();
            },
            _updateMappingTime: function(str, index) {
                var splitted = str.split(":");
                if (splitted.length !== 3) {
                    console.error("Invalid time format. Expected: HH:MM:SS, was: " + this);
                    return;
                }
                var hoursSec = parseInt(splitted[0]) * 3600;
                var minutesSec = parseInt(splitted[1]) * 60;
                var newTime = hoursSec + minutesSec + parseInt(splitted[2]);
                return this.$.timeGrider.changeMapping(index, newTime);

            },
            _timeFromChanged: function(e) {
                e.preventDefault();
                var newTime = this._updateMappingTime(this.timeFrom, this.selectedIndex);
                this.set('timeFrom', newTime.toHHMMSS());
            },
            _timeToChanged: function(e) {
                e.preventDefault();
                var newTime = this._updateMappingTime(this.timeTo, this.selectedIndex + 1);
                this.set('timeTo', newTime.toHHMMSS());
            }
        });
    </script>
</dom-module>
