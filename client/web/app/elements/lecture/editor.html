<dom-module id="lecture-editor">
    <style>
        .slider{
            padding: 20px;
            width: 100%;
        }
        .tool-bar {
            @apply(--layout-horizontal);
            @apply(--layout-justified);
        }
        .green {
            color: var(--paper-green-300);
        }
        .mt-50 {
            margin-top: 50px;
        }
        h2 {
            color: var(--paper-blue-600);
        }
    </style>
    <template>
        <h2>{{lecture.title}}</h2>
        <div class="row">
            <div class="col-sm-6">
                <paper-input value="{{lecture.title}}" label="Title"></paper-input>
            </div>
            <div class="col-sm-6">
                <paper-input value="{{lecture.description}}" label="Description"></paper-input>
            </div>
        </div>
        <div class="row horizontal layout">
            <div class="col-md-6 col-sm-12">
                <paper-input value="{{videoUrl}}" label="YouTube URL"></paper-input>
                <google-youtube
                        id="presentation"
                        autoplay="1"
                        video-id="{{lecture.videoId}}"
                        height="{{videoHeight}}px"
                        width="100%"
                        rel="0"
                        start="0"
                        autoplay="0"
                        on-google-youtube-ready="_youtubeReady"
                        on-google-youtube-state-change="_youtubeStateChanged"
                        style="margin: auto;">
                </google-youtube>
            </div>
            <div class="col-md-6 col-sm-12 text-center">
                <paper-button style="margin-top: 8px;" on-tap="openPicker" selection="presentationUrl" class="success" raised>
                    <iron-icon icon="file-upload"></iron-icon>Pick file
                </paper-button>
                <pdf-viewer id="pdfViewer" file-id="{{lecture.fileId}}"
                            current-slide="{{currentSlide}}"
                            slide-height="{{videoHeight}}"
                            on-pdf-changed="pdfChanged"></pdf-viewer>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12 slider">
                <time-grider id="timeGrider" editable="true" duration="{{duration}}" mappings="{{lecture.mappings}}" on-choose-slide="_updateSelectedSection"></time-grider>
            </div>
            <div class="col-sm-12">
                <slide-list id="slideList"></slide-list>
            </div>
        </div>

        <div class="tool-bar">
            <div class="layout horizontal">
                <paper-input id="fromInput"  class="flex-none" label="Start time" value="{{timeFrom}}"></paper-input>
                <paper-button id="fromButton" on-tap="timeFromChanged" class="self-end green"><iron-icon icon="check"></iron-icon></paper-button>
            </div>
            <div class="layout horizontal">
                <paper-input id="toInput" class="flex-none" label="End time" value="{{timeTo}}"></paper-input>
                <paper-button id=toButton on-tap="timeToChanged" class="self-end green"><iron-icon icon="check"></iron-icon></paper-button>
            </div>
            <div class="self-end">
                <paper-button class="flex-none" toggles raised on-tap="delete"><iron-icon icon="delete"></iron-icon> Delete</paper-button>
            </div>
        </div>

        <div class="text-center mt-50" style="display:block;">
            <paper-button on-tap="save" class="success" raised>Save</paper-button>
        </div>

        <lectures-service id="lectures" on-response="lecturesResponse" last-response="{{lecture}}"></lectures-service>
        <google-picker id="googlePicker" file-id="{{lecture.fileId}}"></google-picker>
    </template>
    <script>
        Polymer({
            is: 'lecture-editor',
            properties: {
                videoHeight: {
                    type: Number
                },
                selectedIndex: Number,
                timeFrom: Number,
                timeTo: Number,
                videoUrl: {
                    type: String,
                    observer: "_videoUrlChanged"
                },
                lecture: {
                    type: Object,
                    notify: true
                },
                lectureId: {
                    type: String,
                    notify: true,
                    observer: "_loadNewLecture"
                },
                duration: {
                    type: Number
                },
                currentSlide: {
                    type: Number
                },
                pagesCount: {
                    type: Number
                },
                author: {
                    type: String
                }
            },
            observers: [
                'generateNewMappings(lecture.videoId, duration, pagesCount)'
            ],
            pdfChanged: function(e) {
                this.$.slideList.set('pdf', e.detail.value);
                this.set('pagesCount', e.detail.value.numPages);
            },
            _videoUrlChanged: function(videoUrl) {
                if (StringUtils.isEmpty(videoUrl)) {
                    return;
                }
                var videoId = UrlUtils.getParam(videoUrl, "v");
                this.set('lecture.videoId', videoId);
            },
            _updateSelectedSection: function(e) {
                var self = this;

                function getNextTime(index) {
                    if (index < self.lecture.mappings.length - 1) {
                        return self.lecture.mappings[index + 1].time;
                    }
                    return self.duration;
                }

                this.selectedIndex = e.detail.index;

                console.log("Updating form");
                this.timeFrom = this.lecture.mappings[this.selectedIndex].time.toHHMMSS();
                this.timeTo = getNextTime(this.selectedIndex).toHHMMSS();

                var isFirst = this.selectedIndex === 0;
                this.$.fromButton.disabled = isFirst;
                this.$.fromInput.disabled = isFirst;

                var isLast = this.selectedIndex === this.lecture.mappings.length - 1;
                this.$.toButton.disabled = isLast;
                this.$.toInput.disabled = isLast;

                console.log("Updating video and presentation view");
                var selectedMapping = this.lecture.mappings[this.selectedIndex];
                this.async(function() {
                    this.$.presentation.seekTo(selectedMapping.time);
                }, 10);
                this.setCurrentSlide(selectedMapping.slide);
            },
            setCurrentSlide: function(slide) {
                this.set("currentSlide", slide);
            },
            _youtubeReady: function(e) {
                this.set('duration', GoogleYouTubeUtils.getVideoDuration(e));
            },
            _youtubeStateChanged: function(e) {
                var newDuration = GoogleYouTubeUtils.getVideoDuration(e);
                if (newDuration !== 0 && this.duration !== newDuration) {
                    this.set('duration', newDuration);
                }
            },
            _loadNewLecture: function() {
                this.$.lectures.get(this.lectureId);
            },
            openPicker: function() {
                this.$.googlePicker.openPicker();
            },
            generateNewMappings: function(videoUrl, duration, pagesCount) {
                if (duration === 0) {
                    console.log("Mappings will not be generated, duration: " + duration + " is not valid");
                    return;
                }

                if (ArrayUtils.isNotEmpty(this.lecture.mappings)) {
                    return;
                }
                console.log("Generating default mappings");
                var mappings = [];
                var singleDur = this.duration / pagesCount;
                for (var i = 0; i < pagesCount; i++) {
                    mappings.push({
                        time: Math.round(singleDur * i),
                        slide: i
                    });
                }
                this.set('lecture.mappings', mappings);
            },
            ready: function() {
                this.videoHeight = GoogleYouTubeUtils.determinePreferredHeight();

                var self = this;
                if (this.lectureId === undefined) {
                    console.log("lectureId not found. Creating new object");
                    this.lecture = {
                        videoUrl: undefined,
                        fileId: undefined,
                        title: undefined,
                        description: undefined,
                        mappings: []
                    };
                }

                page.exit('/lecture/:id/edit', function(ctx, next) {
                    self.$.presentation.pause();
                    next();
                });
            },
            save: function() {
                if (this.lectureId === undefined) {
                    this.set('lecture.author', this.author);
                    this.$.lectures.create(this.lecture);
                } else {
                    this.$.lectures.update(this.lectureId, this.lecture);
                }
            },
            delete: function() {
                this.lecture.mappings.splice(this.selectedIndex, 1);
                this.$.timeGrider.mappingChanged();
            },
            updateMappingTime: function(str, mapping) {
                var splitted = str.split(":");
                if (splitted.length !== 3) {
                    console.error("Invalid time format. Expected: HH:MM:SS, was: " + this);
                    return;
                }
                var hoursSec = parseInt(splitted[0]) * 3600;
                var minutesSec = parseInt(splitted[1]) * 60;
                mapping.time = hoursSec + minutesSec + parseInt(splitted[2]);
                this.$.timeGrider.mappingChanged();
            },
            timeFromChanged: function() {
                this.updateMappingTime(this.timeFrom, this.lecture.mappings[this.selectedIndex]);
                this.$.timeGrider.select(this.selectedIndex);
            },
            timeToChanged: function() {
                this.updateMappingTime(this.timeTo, this.lecture.mappings[this.selectedIndex + 1]);
                this.$.timeGrider.select(this.selectedIndex);
            },
            lecturesResponse: function() {
                var last = this.$.lectures.lastResponse;
                if (last.$oid !== undefined) {
                    page('/lecture/' + last.$oid);
                } else if (last.status !== undefined && this.lectureId !== undefined) {
                    page('/lecture/' + this.lectureId);
                }
            },
            setAuthor: function(author) {
                this.set('author', author);
            }
        });
    </script>
</dom-module>
